image: gcr.io/kubernetes-charts-ci/test-image:v3.3.2

stages:
  - test
  - build

before_script:
  # APK
  - apk -Uuv add bash curl groff less openssl python py-pip
  - pip install awscli
  # Helm
  - curl -fSL https://git.io/get_helm.sh | bash -
  - helm init --client-only
  - helm plugin install https://github.com/chartmuseum/helm-push
  - helm plugin install https://github.com/lrills/helm-unittest

validate:
  only:
    changes:
      - stable/*
    refs:
      - branches
  except:
    refs:
      - master
  script:
    - git remote add helm https://oauth2:$GITLAB_ACCESS_TOKEN@gitlab.com/stackvista/devops/helm-charts
    - git fetch helm
    - ct lint --config test/ct.yaml
  stage: test
  tags:
    - k8s-medium

push:
  dependencies:
    - validate
  only:
    changes:
      - stable/*
    refs:
      - master
  script:
    - bash test/sync-repo.sh
  stage: build
  tags:
    - k8s-medium
