{{- define "stackstate.apiKey.secret" -}}
metadata:
  name: {{ template "common.fullname.short" . }}-api-key
data:
  API_KEY: {{ .stsApiKey | b64enc | quote }}
{{- end -}}


{{/*
  Logic to determine receiver api key.
  */}}
  {{- define "receiver.apiKey" -}}
  {{- if .Values.global }}
    {{- coalesce .Values.global.receiverApiKey .Values.stackstate.receiver.apiKey -}}
  {{- else -}}
    {{- coalesce .Values.stackstate.receiver.apiKey -}}
  {{- end -}}
  {{- end -}}

{{- if not .Values.stackstate.apiKey.fromExternalSecret }}
{{- $commonSecret := fromYaml (include "common.secret" .) -}}

{{- $providedApiKey := include "suse-observability.global.receiverApiKey" . }}
{{- $finalApiKey := "" }}
{{- $isGlobalMode := include "suse-observability.global.enabled" . }}

{{- if $isGlobalMode }}
  {{- /* Global mode: Declarative approach - use provided value if specified, optional if not */}}
  {{- /* No lookup needed in global mode - fully declarative */}}
  {{- if $providedApiKey }}
    {{- $finalApiKey = $providedApiKey }}
  {{- end }}
{{- else }}
  {{- /* Legacy mode: Maintain backward compatibility - lookup existing secret */}}
  {{- $existingSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-api-key" (include "common.fullname.short" .)) }}
  {{- $existingApiKey := "" }}
  {{- if $existingSecret }}
    {{- $existingApiKey = index $existingSecret.data "API_KEY" | b64dec }}
  {{- end }}

  {{- if $existingApiKey }}
    {{- /* We have an existing API key - use it unless user explicitly provides a different one */}}
    {{- if $providedApiKey }}
      {{- if ne $providedApiKey $existingApiKey }}
        {{- $finalApiKey = $providedApiKey }}
      {{- else }}
        {{- $finalApiKey = $existingApiKey }}
      {{- end }}
    {{- else }}
      {{- /* No API key provided - use existing for backward compatibility */}}
      {{- $finalApiKey = $existingApiKey }}
    {{- end }}
  {{- else }}
    {{- /* No existing API key - use provided value if specified */}}
    {{- if $providedApiKey }}
      {{- $finalApiKey = $providedApiKey }}
    {{- end }}
  {{- end }}
{{- end }}

{{- if $finalApiKey }}
{{- $stackstateApiKeySecret := fromYaml (include "stackstate.apiKey.secret" (merge (dict "stsApiKey" $finalApiKey) .)) -}}
{{- toYaml (merge $stackstateApiKeySecret $commonSecret) -}}
{{- end }}

{{- end }}
