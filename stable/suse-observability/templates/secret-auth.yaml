{{- define "stackstate.auth.secret" -}}
metadata:
  name: {{ template "common.fullname.short" . }}-auth
data:
{{- $apiAuth := .Values.stackstate.authentication -}}
{{- $authTypes := list -}}

{{- if $apiAuth.ldap }}
{{ $authTypes = append $authTypes "ldapAuthServer" }}
  {{- if $apiAuth.ldap.bind }}
  ldap_password: {{ $apiAuth.ldap.bind.password | b64enc | quote }}
  {{- end }}
{{- end }}

{{- if $apiAuth.oidc }}
{{- $authTypes = append $authTypes "oidcAuthServer" }}
  oidc_client_id: {{ $apiAuth.oidc.clientId | required "OIDC authentication requires the client id to be set." | b64enc | quote }}
  oidc_secret: {{ $apiAuth.oidc.secret | required "OIDC authentication requires the client secret to be set." | b64enc | quote }}
{{- end }}

{{- if $apiAuth.rancher }}
  {{- if has "oidcAuthServer" $authTypes }}
  {{- fail "Cannot configure both stackstate.authentication.oidc and stackstate.authentication.rancher simultaneously. Please choose one authentication method." -}}
  {{- else }}
  {{- $authTypes = append $authTypes "oidcAuthServer" }}
    oidc_client_id: {{ $apiAuth.rancher.clientId | required "Rancher authentication requires the client id to be set." | b64enc | quote }}
    oidc_secret: {{ $apiAuth.rancher.secret | required "Rancher authentication requires the client secret to be set." | b64enc | quote }}
  {{- end }}
{{- end }}

{{- if $apiAuth.keycloak }}
{{- $authTypes = append $authTypes "keycloakAuthServer" }}
  keycloak_client_id: {{ $apiAuth.keycloak.clientId | required "Keycloak authentication requires the client id to be set." | b64enc | quote }}
  keycloak_secret: {{ $apiAuth.keycloak.secret | required "Keycloak authentication requires the client secret to be set." | b64enc | quote }}
{{- end }}

{{- if $apiAuth.file }}
{{- $authTypes = append $authTypes "stackstateAuthServer" }}
{{- if not $apiAuth.file.logins -}}
{{- fail "File configuration requires a non-empty list of logins to be specified with fields username, passwordHash and roles specified." -}}
{{- end }}
{{- range $apiAuth.file.logins }}
  {{- if not .roles -}}
  {{- printf "No roles specified for user %s" .username | fail -}}
  {{- end }}
  {{- if not (regexMatch "^[A-Za-z0-9_]+$" (.username | required "A login requires a username")) }}
    {{ printf "Only alphanumeric and _ are allowed for user names: %s." .username | fail }}
  {{- end }}
  file_{{ .username }}_password: {{ .passwordHash | default .passwordMd5 | required "A login requires a password hash" | b64enc | quote }}
{{- end }}
{{- end }}

{{/*
Fallback to a standard 'admin' user with a specified password. Convenient for quick tests and configuration, but
for production this should be replaced with one of the other mechanisms.
*/}}
{{- if eq (len $authTypes) 0 }}
{{- $authTypes = append $authTypes "stackstateAuthServer" }}
{{- /* Always try to lookup existing secret first to avoid unnecessary updates */}}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-auth" (include "common.fullname.short" .)) }}
{{- $existingPassword := "" }}
{{- if $existingSecret }}
  {{- $existingPassword = index $existingSecret.data "default_password" | b64dec }}
{{- end }}

{{- $providedPassword := include "suse-observability.global.adminPassword" . | default $apiAuth.adminPassword }}
{{- $finalPassword := "" }}
{{- $isGlobalMode := include "suse-observability.global.enabled" . }}

{{- if $isGlobalMode }}
  {{- /* Global mode: Always require password to be explicitly provided (declarative approach) */}}
  {{- $finalPassword = $providedPassword | required "global.suseObservability.adminPassword is required when using global.suseObservability configuration. Please provide a bcrypt-hashed password." }}
  {{- /* Validate it's a bcrypt hash */}}
  {{- if not (regexMatch "^\\$2[abxy]{0,1}\\$(0[4-9]|[12][0-9]|3[01])\\$[./0-9a-zA-Z]{53}$" $finalPassword) }}
    {{- fail "global.suseObservability.adminPassword must be a bcrypt hash. Plain text passwords are not accepted in global.suseObservability mode." }}
  {{- end }}
  {{- /* Compare with existing to avoid unnecessary updates */}}
  {{- if $existingPassword }}
    {{- if eq $finalPassword $existingPassword }}
      {{- /* Same password - use existing to avoid secret update */}}
      {{- $finalPassword = $existingPassword }}
    {{- end }}
  {{- end }}
{{- else }}
  {{- /* Legacy mode: Maintain backward compatibility */}}
  {{- if $existingPassword }}
    {{- /* We have an existing password - use it unless user explicitly provides a different one */}}
    {{- if $providedPassword }}
      {{- /* Check if password is already hashed (bcrypt or MD5) */}}
      {{- $isBcrypt := regexMatch "^\\$2[abxy]{0,1}\\$(0[4-9]|[12][0-9]|3[01])\\$[./0-9a-zA-Z]{53}$" $providedPassword }}
      {{- $isMd5 := regexMatch "^[a-f0-9]{32}$" $providedPassword }}
      {{- if or $isBcrypt $isMd5 }}
        {{- if ne $providedPassword $existingPassword }}
          {{- $finalPassword = $providedPassword }}
        {{- else }}
          {{- $finalPassword = $existingPassword }}
        {{- end }}
      {{- else }}
        {{- /* Plain text password in legacy mode - hash it (causes updates on upgrades) */}}
        {{- $finalPassword = $providedPassword | bcrypt }}
      {{- end }}
    {{- else }}
      {{- /* No password provided - use existing for backward compatibility */}}
      {{- $finalPassword = $existingPassword }}
    {{- end }}
  {{- else }}
    {{- /* No existing password (new installation) - require user to provide one */}}
    {{- $finalPassword = $providedPassword | required "Admin password is required for new installations when no other authentication method is configured. Please set 'global.suseObservability.adminPassword' or 'stackstate.authentication.adminPassword'" }}
    {{- /* Legacy mode - accept hashes (bcrypt or MD5) or hash plain text */}}
    {{- $isBcrypt := regexMatch "^\\$2[abxy]{0,1}\\$(0[4-9]|[12][0-9]|3[01])\\$[./0-9a-zA-Z]{53}$" $finalPassword }}
    {{- $isMd5 := regexMatch "^[a-f0-9]{32}$" $finalPassword }}
    {{- if not (or $isBcrypt $isMd5) }}
      {{- $finalPassword = $finalPassword | bcrypt }}
    {{- end }}
  {{- end }}
{{- end }}

  default_password: {{ $finalPassword | b64enc | quote }}
{{- end }}

{{- if gt (len $authTypes) 1 -}}
{{- fail "More than 1 authentication mechanism specified. Please configure only one from: keycloak, oidc, rancher or ldap. If none are configured the default admin user will be made available with the stackstate.authentication.adminPassword." -}}
{{- end }}

{{- if $apiAuth.serviceToken.bootstrap.token }}
{{- $authTypes = append $authTypes "serviceTokenAuthServer" }}
  bootstrap_token: {{ $apiAuth.serviceToken.bootstrap.token | b64enc | quote }}
{{- end }}

{{- end }}

{{- if not .Values.stackstate.authentication.fromExternalSecret }}
{{- $commonSecret := fromYaml (include "common.secret" .) -}}
{{- $stackstateApiKeySecret := fromYaml (include "stackstate.auth.secret" .) -}}
{{- toYaml (merge $stackstateApiKeySecret $commonSecret) -}}
{{- end }}
